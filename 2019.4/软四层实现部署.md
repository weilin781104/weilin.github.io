# 1. 背景

目前上海的项目采用netscaler双机一主一备做应用的负载均衡，未来福建或者其它项目有可能没有硬件四层可以用，所以需要采用软件四层实现应用的负载均衡。

业界性能比较好并且比较成熟的方案是LVS+keepalived，LVS内核空间实现四层（OSI模型）的负载均衡，keepalived实现双机主备切换以及应用健康检查，所以需要在实验环境搭一套试验一下，未将来现网的部署做技术储备，记录下来可做参考。

LVS有四种模型：Director routing,NAT, tunneling,Full-NAT，根据业务需要和网络情况DR和NAT比较常用，所以需要试验这两种模式。另外需要试验多VIP情况，以及主备切换VIP整体漂移。

# 2. 环境准备

## 2.1 设备

| 服务器名 | 内网地址 | 外网地址 | os版本 |
| --- | ---- | ---- | ---- |
| LB01 | 192.168.11.121 | 10.18.14.54 | CentOS Linux release 7.6.1810 (Core) |
| LB02 | 192.168.11.122 | 10.18.14.64 | CentOS Linux release 7.6.1810 (Core) |
| Web01 | 192.168.11.123 | 10.18.14.72 | CentOS Linux release 7.6.1810 (Core)|
| Web02 | 192.168.11.124 | 10.18.14.80 | CentOS Linux release 7.6.1810 (Core)|

## 2.2 OS基础配置

### 2.2.1 查看OS版本

```
[root@lb01 network-scripts]# cat /etc/redhat-release 
CentOS Linux release 7.6.1810 (Core) 
[root@lb01 network-scripts]# uname -a
Linux lb01 3.10.0-957.el7.x86_64 #1 SMP Thu Nov 8 23:39:32 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
```

### 2.2.2 设置网络、路由、默认网关

```
[root@lb01 ~]# cd /etc/sysconfig/network-scripts/
[root@lb01 network-scripts]# vi ifcfg-ens33
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=static
IPADDR=192.168.11.121
NETMASK=255.255.255.0
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=ens33
UUID=0774ae8a-a8d5-4bab-aebb-2e120c125b53
DEVICE=ens33
ONBOOT=yes

[root@lb01 network-scripts]# vi ifcfg-ens34
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=dhcp
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=ens34
UUID=6599a460-2a6f-406d-8cd1-da73f2c4698e
DEVICE=ens34
ONBOOT=yes

[root@lb01 network-scripts]# systemctl restart network

[root@lb01 network-scripts]# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:22:32:13 brd ff:ff:ff:ff:ff:ff
    inet 192.168.11.121/24 brd 192.168.11.255 scope global noprefixroute ens33
       valid_lft forever preferred_lft forever
    inet6 fe80::624:3ad6:dd38:4ce8/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
3: ens34: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:22:32:1d brd ff:ff:ff:ff:ff:ff
    inet 10.18.14.54/20 brd 10.18.15.255 scope global noprefixroute dynamic ens34
       valid_lft 172531sec preferred_lft 172531sec
    inet6 fe80::770b:287a:cab1:986b/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever

[root@lb01 network-scripts]# ip r
default via 10.18.0.254 dev ens34 proto dhcp metric 101 
10.18.0.0/20 dev ens34 proto kernel scope link src 10.18.14.54 metric 101 
192.168.11.0/24 dev ens33 proto kernel scope link src 192.168.11.121 metric 100
       
```

### 2.2.3 设置DNS和hosts

```
[root@lb01 network-scripts]# cat /etc/resolv.conf
# Generated by NetworkManager
search iSANSS.COM
nameserver 10.18.0.251
nameserver 192.168.202.1
[root@lb01 network-scripts]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

```


### 2.2.4 配置hostname

```
[root@lb01 network-scripts]# hostnamectl set-hostname lb01
[root@lb01 network-scripts]# hostnamectl set-icon-name lb01

注： session登出再登入生效

```

### 2.2.5 配置yum

```
备份默认官方yum源
[root@lb01 network-scripts]# cd /etc/yum.repos.d/
[root@lb01 yum.repos.d]# ls
CentOS-Base.repo  CentOS-CR.repo  CentOS-Debuginfo.repo  CentOS-fasttrack.repo  CentOS-Media.repo  CentOS-Sources.repo  CentOS-Vault.repo
[root@lb01 yum.repos.d]# mv CentOS-Base.repo CentOS-Base.repo.bak

下载aliyun yum源
[root@lb01 yum.repos.d]# curl  http://mirrors.aliyun.com/repo/Centos-7.repo -o CentOS-Base.repo    
[root@lb01 yum.repos.d]# yum repolist
[root@lb01 yum.repos.d]# yum clean all
[root@lb01 yum.repos.d]# yum makecache
[root@lb01 yum.repos.d]# yum update

安装epel源
[root@lb01 yum.repos.d]# yum install -y  epel-release
[root@lb01 yum.repos.d]# mv epel.repo epel.repo.bak
[root@lb01 yum.repos.d]# curl http://mirrors.aliyun.com/repo/epel-7.repo -o epel-7.repo
[root@lb01 yum.repos.d]# yum repolist
```



### 2.2.6 配置防火墙和网络管理工具

```
[root@lb01 network-scripts]# systemctl stop firewalld
[root@lb01 network-scripts]# systemctl disable firewalld
Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.
Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.

[root@lb01 yum.repos.d]# yum install -y iptables-services


[root@lb01 network-scripts]# systemctl stop NetworkManager
[root@lb01 network-scripts]# systemctl disable NetworkManager
Removed symlink /etc/systemd/system/multi-user.target.wants/NetworkManager.service.
Removed symlink /etc/systemd/system/dbus-org.freedesktop.NetworkManager.service.
Removed symlink /etc/systemd/system/dbus-org.freedesktop.nm-dispatcher.service.
Removed symlink /etc/systemd/system/network-online.target.wants/NetworkManager-wait-online.service.
```

### 2.2.7 禁止swap分区

现在越来越多的软件需要禁用swap分区

```
刷新SWAP
可以执行命令刷新一次SWAP（将SWAP里的数据转储回内存，并清空SWAP里的数据）
[root@lb01 yum.repos.d]# swapoff -a && swapon -a

临时生效：sysctl -w vm.swappiness=0
永久生效：
[root@lb01 yum.repos.d]# echo "vm.swappiness = 0">> /etc/sysctl.conf
（尽量不使用交换分区，注意不是禁用）
```



### 2.2.8 禁止selinux

```
临时关闭：
[root@lb01 network-scripts]# setenforce 0
[root@lb01 network-scripts]# getenforce
Permissive

永久关闭：
[root@lb01 network-scripts]# vi /etc/selinux/config
SELINUX=disabled

注：需要重启生效
```

### 2.2.9 升级内核

```
[root@lb01 yum.repos.d]# rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
[root@lb01 yum.repos.d]# rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm
[root@lb01 yum.repos.d]# yum --disablerepo="*" --enablerepo="elrepo-kernel" list available
可安装的软件包
kernel-lt.x86_64                               4.4.179-1.el7.elrepo                                      elrepo-kernel
kernel-lt-devel.x86_64                         4.4.179-1.el7.elrepo                                      elrepo-kernel
kernel-lt-doc.noarch                           4.4.179-1.el7.elrepo                                      elrepo-kernel
kernel-lt-headers.x86_64                       4.4.179-1.el7.elrepo                                      elrepo-kernel
kernel-lt-tools.x86_64                         4.4.179-1.el7.elrepo                                      elrepo-kernel
kernel-lt-tools-libs.x86_64                    4.4.179-1.el7.elrepo                                      elrepo-kernel
kernel-lt-tools-libs-devel.x86_64              4.4.179-1.el7.elrepo                                      elrepo-kernel
kernel-ml.x86_64                               5.0.10-1.el7.elrepo                                       elrepo-kernel
kernel-ml-devel.x86_64                         5.0.10-1.el7.elrepo                                       elrepo-kernel
kernel-ml-doc.noarch                           5.0.10-1.el7.elrepo                                       elrepo-kernel
kernel-ml-headers.x86_64                       5.0.10-1.el7.elrepo                                       elrepo-kernel
kernel-ml-tools.x86_64                         5.0.10-1.el7.elrepo                                       elrepo-kernel
kernel-ml-tools-libs.x86_64                    5.0.10-1.el7.elrepo                                       elrepo-kernel
kernel-ml-tools-libs-devel.x86_64              5.0.10-1.el7.elrepo                                       elrepo-kernel

ml是最新版本，lt是长期支持版本，建议安装lt
[root@lb01 yum.repos.d]# yum --enablerepo=elrepo-kernel install kernel-lt
[root@lb01 ~]# grub2-mkconfig -o /boot/grub2/grub.cfg
[root@lb01 ~]# awk -F\' '$1=="menuentry " {print i++ " : " $2}' /etc/grub2.cfg
0 : CentOS Linux (4.4.179-1.el7.elrepo.x86_64) 7 (Core)
1 : CentOS Linux (3.10.0-957.10.1.el7.x86_64) 7 (Core)
2 : CentOS Linux (3.10.0-957.el7.x86_64) 7 (Core)
3 : CentOS Linux (0-rescue-7b7ca43801254df58a19e96313c6f3d5) 7 (Core)

[root@lb01 yum.repos.d]# vi /etc/default/grub
GRUB_DEFAULT=0
[root@lb01 yum.repos.d]# reboot

[root@lb01 ~]# uname -a
Linux lb01 4.4.179-1.el7.elrepo.x86_64 #1 SMP Sat Apr 27 08:29:04 EDT 2019 x86_64 x86_64 x86_64 GNU/Linux
```



# 3. LVS DR+Keepalived

## 3.1 配置

### 3.1.1 web服务器

1. 在lo上添加vip
2. 加arp抑制的配置

#### 3.1.1.1 web01

```
[root@web01 html]# ip addr add 10.18.14.90/20 dev lo  
[root@web01 html]# ip addr add 10.18.14.91/20 dev lo 
[root@web01 html]# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet 10.18.14.90/20 scope global lo
       valid_lft forever preferred_lft forever
    inet 10.18.14.91/20 scope global secondary lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:57:02:a1 brd ff:ff:ff:ff:ff:ff
    inet 192.168.11.123/24 brd 192.168.11.255 scope global ens33
       valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fe57:2a1/64 scope link 
       valid_lft forever preferred_lft forever
3: ens34: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:57:02:ab brd ff:ff:ff:ff:ff:ff
    inet 10.18.14.72/20 brd 10.18.15.255 scope global dynamic ens34
       valid_lft 172791sec preferred_lft 172791sec
    inet6 fe80::20c:29ff:fe57:2ab/64 scope link 
       valid_lft forever preferred_lft forever
[root@web01 html]#  echo "1" >/proc/sys/net/ipv4/conf/lo/arp_ignore
[root@web01 html]# echo "2" >/proc/sys/net/ipv4/conf/lo/arp_announce
[root@web01 html]# echo "1" >/proc/sys/net/ipv4/conf/all/arp_ignore
[root@web01 html]# echo "2" >/proc/sys/net/ipv4/conf/all/arp_announce
[root@web01 html]# echo "1" >/proc/sys/net/ipv4/conf/ens34/arp_ignore
[root@web01 html]# echo "2" >/proc/sys/net/ipv4/conf/ens34/arp_announce
```

#### 3.1.1.2 web02

```
[root@web02 html]# ip addr add 10.18.14.90/20 dev lo                      
[root@web02 html]# ip addr add 10.18.14.91/20 dev lo 
[root@web02 html]# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet 10.18.14.90/20 scope global lo
       valid_lft forever preferred_lft forever
    inet 10.18.14.91/20 scope global secondary lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:c1:47:e6 brd ff:ff:ff:ff:ff:ff
    inet 192.168.11.124/24 brd 192.168.11.255 scope global ens33
       valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fec1:47e6/64 scope link 
       valid_lft forever preferred_lft forever
3: ens34: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:c1:47:f0 brd ff:ff:ff:ff:ff:ff
    inet 10.18.14.80/20 brd 10.18.15.255 scope global dynamic ens34
       valid_lft 172787sec preferred_lft 172787sec
    inet6 fe80::20c:29ff:fec1:47f0/64 scope link 
       valid_lft forever preferred_lft forever
[root@web02 html]#  echo "1" >/proc/sys/net/ipv4/conf/lo/arp_ignore
[root@web02 html]# echo "2" >/proc/sys/net/ipv4/conf/lo/arp_announce
[root@web02 html]# echo "1" >/proc/sys/net/ipv4/conf/all/arp_ignore
[root@web02 html]# echo "2" >/proc/sys/net/ipv4/conf/all/arp_announce
[root@web02 html]# echo "1" >/proc/sys/net/ipv4/conf/ens34/arp_ignore
[root@web02 html]# echo "2" >/proc/sys/net/ipv4/conf/ens34/arp_announce
```



### 3.1.2 lb服务器

1. 配置keepalived.conf

注：实验环境网段不支持多播，所以vrrp配置采用单播方式



#### 3.1.2.1 lb01

```
[root@lb01 ~]# cd /etc/keepalived/
[root@lb01 keepalived]# mv keepalived.conf keepalived.conf.template
[root@lb01 keepalived]# vi keepalived.conf
vrrp_instance VI_1 {
    state MASTER
    interface ens34
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        10.18.14.90
        10.18.14.91
    }
    unicast_src_ip 10.18.14.54
    unicast_peer {
       10.18.14.64
    }
}

virtual_server 10.18.14.90 80 {
    delay_loop 6
    lb_algo rr
    lb_kind DR
    persistence_timeout 0
    protocol TCP

    real_server 10.18.14.72 80 {
        weight 1
        TCP_CHECK {
            connect_port 80
            connect_timeout 2
            retry 3
            delay_before_retry 3
            
        }
    }

    real_server 10.18.14.80 80 {
        weight 1
        TCP_CHECK {
            connect_port 80
            connect_timeout 2
            nb_get_retry 3
            delay_before_retry 3        
        }
    }
}

virtual_server 10.18.14.91 81 {
    delay_loop 6
    lb_algo rr
    lb_kind DR
    persistence_timeout 0
    protocol TCP

    real_server 10.18.14.72 80 {
        weight 1
        TCP_CHECK {
            connect_port 80
            connect_timeout 2
            nb_get_retry 3
            delay_before_retry 3           
        }
    }
}

virtual_server 10.18.14.91 82 {
    delay_loop 6
    lb_algo rr
    lb_kind DR
    persistence_timeout 0
    protocol TCP

    real_server 10.18.14.80 80 {
        weight 1
        TCP_CHECK {
            connect_port 80
            connect_timeout 10
            nb_get_retry 3
            delay_before_retry 3            
        }
    }
}
[root@lb01 keepalived]# systemctl restart keepalived
[root@lb01 keepalived]# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:22:32:13 brd ff:ff:ff:ff:ff:ff
    inet 192.168.11.121/24 brd 192.168.11.255 scope global ens33
       valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fe22:3213/64 scope link 
       valid_lft forever preferred_lft forever
3: ens34: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:22:32:1d brd ff:ff:ff:ff:ff:ff
    inet 10.18.14.54/20 brd 10.18.15.255 scope global dynamic ens34
       valid_lft 149465sec preferred_lft 149465sec
    inet 10.18.14.90/32 scope global ens34
       valid_lft forever preferred_lft forever
    inet 10.18.14.91/32 scope global ens34
       valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fe22:321d/64 scope link 
       valid_lft forever preferred_lft forever

```
#### 3.1.2.2 lb02

```
[root@lb02 ~]# cd /etc/keepalived/
[root@lb02 keepalived]# mv keepalived.conf keepalived.conf.template
[root@lb02 keepalived]# vi keepalived.conf
vrrp_instance VI_1 {
    state MASTER
    interface ens34
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        10.18.14.90
        10.18.14.91
    }
    unicast_src_ip 10.18.14.54
    unicast_peer {
       10.18.14.64
    }
}

virtual_server 10.18.14.90 80 {
    delay_loop 6
    lb_algo rr
    lb_kind DR
    persistence_timeout 0
    protocol TCP

    real_server 10.18.14.72 80 {
        weight 1
        TCP_CHECK {
            connect_port 80
            connect_timeout 2
            retry 3
            delay_before_retry 3
            
        }
    }

    real_server 10.18.14.80 80 {
        weight 1
        TCP_CHECK {
            connect_port 80
            connect_timeout 2
            nb_get_retry 3
            delay_before_retry 3        
        }
    }
}

virtual_server 10.18.14.91 81 {
    delay_loop 6
    lb_algo rr
    lb_kind DR
    persistence_timeout 0
    protocol TCP

    real_server 10.18.14.72 80 {
        weight 1
        TCP_CHECK {
            connect_port 80
            connect_timeout 2
            nb_get_retry 3
            delay_before_retry 3           
        }
    }
}

virtual_server 10.18.14.91 82 {
    delay_loop 6
    lb_algo rr
    lb_kind DR
    persistence_timeout 0
    protocol TCP

    real_server 10.18.14.80 80 {
        weight 1
        TCP_CHECK {
            connect_port 80
            connect_timeout 10
            nb_get_retry 3
            delay_before_retry 3            
        }
    }
 }
 [root@lb02 keepalived]# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:72:52:0c brd ff:ff:ff:ff:ff:ff
    inet 192.168.11.122/24 brd 192.168.11.255 scope global ens33
       valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fe72:520c/64 scope link 
       valid_lft forever preferred_lft forever
3: ens34: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:72:52:16 brd ff:ff:ff:ff:ff:ff
    inet 10.18.14.64/20 brd 10.18.15.255 scope global dynamic ens34
       valid_lft 148586sec preferred_lft 148586sec
    inet6 fe80::20c:29ff:fe72:5216/64 scope link 
       valid_lft forever preferred_lft forever
```

 

## 3.2 测试

```

```

